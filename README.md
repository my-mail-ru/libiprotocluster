# libiprotocluster

Библиотека предназначена для синхронной/асинхронной работы с кластером серверов, работающих по протоколу iproto.
Подходит для взаимодействия с хранилищами семейства [Octopus](https://github.com/delamonpansie/octopus),
а также с [Tarantool](https://github.com/tarantool/tarantool) до версии 1.5 включительно.

## Возможности

* асинхронная работа с несколькими серверами внутри синхронного и асинхронного кода;
* автоматическое использование одного соединения к одному _host:port_;
* шардинг (о алгоритме распределения заботится внешний код);
* балансировка нагрузки между несколькими равноправными серверами;
* приоритезация серверов, с переходом к менее приоритетным серверам только в случае ошибок работы с более приоритетными;
* реплики, переключение на реплику при недоступности мастера либо наоборот;
* повторное выполнение запроса в случае ошибок, либо в случае возврата сервером соответствующего кода;
* пингер (при сборке с параметром `MY_MAIL_RU`);
* сбор статистки по количеству и среднему времени запросов с агрегацией статистики за интервал времени;
* возврат статистической информации во внешний код через callback;
* запись статистики в _graphite_ (при сборке с параметром `WITH_GRAPHITE`).

## Опции сообщения

* `max_tries` - максимальное количество попыток (всегда больше 0, по умолчанию 3);
* `shard_num` - номер используемого шарда (нумеруются с 1), обязателен, если шардов больше 1;
* `from` - порядок обращений к серверам при попытках:
  * `FROM_MASTER` - только мастер (по умолчанию);
  * `FROM_REPLICA` - только реплика;
  * `FROM_MASTER_REPLICA` - сначала мастер, если не получилось, то реплика;
  * `FROM_REPLICA_MASTER` - сначала реплика, если не получилось, то мастер;
* `retry` - стратегия перепопыток, битовая маска:
  * `RETRY_EARLY` - выполнять ранние перепопытки;
  * `RETRY_SAFE` - делать перепопытку только если запрос еще не ушел на сервер (по умолчанию);
  * `RETRY_SAME` - делать перепопытку всегда к тому же самому серверу (во избежание дупликатов например);
* `timeout` - таймаут на запрос (не включает время необходимое на установление соединения, по умолчанию 500 мс.);
* `early_timeout` - время, через которое выполнять ранние перепопытки (актуально, если `(retry & RETRY_EARLY)`, по умолчанию 50 мс.);
* `callback` - callback, который необходимо вызвать по выполнению запроса;
* `soft_retry_delay_min`, `soft_retry_delay_max` - диапазон задержек перед программными перепопытками, при каждой перепопытке задержки возрастают от минимальной до максимальной (по умолчанию 100 и 900 мс. соответственно);
* `soft_retry_callback` - callback, который должен вернуть `true`, если необходимо выполнить программную перепопытку;
* `data` - произвольное `void *` для сопоставления внешних данных с запросом, которое никак не используется самой библиотекой.

Ранние перепопытки работают следующим образом. После истечения `early_timeout` от времени отправки запроса,
запрос повторяется параллельно еще на два сервера (запрос к первому серверу не прерывается).
Далее, в течение времени оставшегося до `timeout`, ожидается ответ от любого сервера и, по его получению,
запросы к другим серверам отменяются.

## Установка

### Зависимости

* cmake
* gcc
* libev

### Сборка

```
cmake .
make
make install
```
